# 5ì¥: ìŠ¤ë ˆë“œ í˜‘ë ¥ (Thread Cooperation)

---

## 5.1 ì±•í„° ëª©í‘œ (Chapter Objectives)

ì´ ì¥ì—ì„œ ë°°ìš°ëŠ” ê²ƒ:

* CUDA Cì—ì„œ â€œthreadâ€ì˜ ê°œë… ì´í•´
* ì„œë¡œ ë‹¤ë¥¸ threadë“¤ì´ **í†µì‹ í•˜ëŠ” ë°©ë²•**
* ë³‘ë ¬ ì‹¤í–‰ë˜ëŠ” threadë“¤ì„ **ë™ê¸°í™”í•˜ëŠ” ë°©ë²•**

ğŸ‘‰ ì• ì¥ì—ì„œëŠ” block ë‹¨ìœ„ ë³‘ë ¬ì„±ë§Œ ë‹¤ë¤˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” block ë‚´ë¶€ì˜ threadë“¤ì´ ì–´ë–»ê²Œ **í˜‘ë ¥(cooperate)**í•˜ëŠ”ì§€ë¥¼ ë°°ìš°ê²Œ ë©ë‹ˆë‹¤.

---

## 5.2 ë¸”ë¡ì„ ìŠ¤ë ˆë“œë¡œ ë‚˜ëˆ„ê¸° (Splitting Parallel Blocks)

* ì´ì „ ì¥ì—ì„œëŠ” `add<<<N,1>>>` í˜•íƒœë¡œ blockì„ ì—¬ëŸ¬ ê°œ ì‹¤í–‰ â†’ ê° blockì´ ë²¡í„°ì˜ í•œ ì›ì†Œë¥¼ ì²˜ë¦¬.
* í•˜ì§€ë§Œ CUDAëŠ” blockì„ ë‹¤ì‹œ ì—¬ëŸ¬ ê°œì˜ threadë¡œ ìª¼ê°¤ ìˆ˜ ìˆìŒ.
* ì¦‰, `add<<<1,N>>>` ì‹¤í–‰ ì‹œ â†’ **block 1ê°œ, thread Nê°œ**
  ì´ ê²½ìš° ê° threadê°€ í•˜ë‚˜ì˜ ì›ì†Œë¥¼ ë‹´ë‹¹.

### ì½”ë“œ ì˜ˆì‹œ (Vector Add - Thread ê¸°ë°˜)

```c
__global__ void add(int *a, int *b, int *c) {
    int tid = threadIdx.x;   // blockì´ ì•„ë‹ˆë¼ thread ì¸ë±ìŠ¤ ì‚¬ìš©
    if (tid < N)
        c[tid] = a[tid] + b[tid];
}

int main(void) {
    ...
    add<<<1, N>>>(dev_a, dev_b, dev_c); // block=1, thread=N
    ...
}
```

ğŸ‘‰ í•µì‹¬: **`blockIdx.x` â†’ `threadIdx.x`**ë¡œ ë°”ë€œ.

---

## 5.3 ë” ê¸´ ë²¡í„° ì²˜ë¦¬ (GPU Sums of a Longer Vector)

ë¬¸ì œ: blockë‹¹ ìµœëŒ€ thread ìˆ˜(`maxThreadsPerBlock`) ì œí•œ ì¡´ì¬ (ì˜ˆ: 512 ë˜ëŠ” 1024).
â†’ ê¸´ ë²¡í„°ë¥¼ ì²˜ë¦¬í•˜ë ¤ë©´ **ì—¬ëŸ¬ block + ì—¬ëŸ¬ thread** ì¡°í•© í•„ìš”.

### ìƒˆë¡œìš´ ì¸ë±ì‹± ë°©ì‹

```c
int tid = threadIdx.x + blockIdx.x * blockDim.x;
```

* `threadIdx.x` : block ë‚´ ìœ„ì¹˜
* `blockIdx.x * blockDim.x` : block ë‹¨ìœ„ offset
* ë‘˜ì„ í•©ì³ì„œ **ì „ì²´ threadì˜ ê¸€ë¡œë²Œ id**ë¥¼ êµ¬í•¨.

### ì‹¤í–‰ ì˜ˆì‹œ

```c
add<<<(N+127)/128, 128>>>(dev_a, dev_b, dev_c);
```

* blockë‹¹ 128 thread
* ì´ thread ìˆ˜ â‰¥ Nì´ ë˜ë„ë¡ `(N+127)/128` block ì‹¤í–‰
* overshoot ëœ threadëŠ” `if (tid < N)` ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§

---

## 5.4 ì„ì˜ ê¸¸ì´ ë²¡í„° ì²˜ë¦¬ (GPU Sums of Arbitrarily Long Vectors)

block ìˆ˜ì—ë„ ì œí•œ ìˆìŒ (`gridDim.x â‰¤ 65535`).
â†’ ë²¡í„° ê¸¸ì´ê°€ ë§¤ìš° í¬ë©´ ë‹¨ìˆœ block ë¶„í• ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±.

### í•´ê²°: while ë£¨í”„ë¥¼ í†µí•œ stride ì ‘ê·¼

```c
__global__ void add(int *a, int *b, int *c) {
    int tid = threadIdx.x + blockIdx.x * blockDim.x;
    while (tid < N) {
        c[tid] = a[tid] + b[tid];
        tid += blockDim.x * gridDim.x;  // stride jump
    }
}
```

ğŸ‘‰ threadë“¤ì´ ì „ì²´ ë²¡í„°ë¥¼ â€œstrideâ€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ  ë§¡ìŒ.

ì´ ë°©ì‹ì€ CPUì—ì„œ ë‹¤ì¤‘ ì½”ì–´ ë£¨í”„ë¥¼ ì„¤ê³„í•  ë•Œ â€œi += num_processorsâ€ í•˜ë˜ ê²ƒê³¼ ë¹„ìŠ·í•©ë‹ˆë‹¤.

---

## 5.5 ì‹¤ìŠµ ì˜ˆì œ: GPU Ripple ì• ë‹ˆë©”ì´ì…˜

ì±…ì—ì„œëŠ” ë‹¨ìˆœ ë²¡í„° ì—°ì‚° ëŒ€ì‹  **ë¦¬í”Œ(Ripple) íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜**ì„ GPUë¡œ ìƒì„±í•˜ëŠ” ì˜ˆì œë¥¼ ì œì‹œ.

### ì£¼ìš” ê°œë…

* `dim3 blocks(DIM/16, DIM/16);`
* `dim3 threads(16,16);`
  â†’ 2ì°¨ì› ë¸”ë¡, 2ì°¨ì› ìŠ¤ë ˆë“œ â†’ í•œ í”½ì…€ë‹¹ 1 thread ë§¤í•‘.

### ì»¤ë„ ì½”ë“œ

```c
__global__ void kernel(unsigned char *ptr, int ticks) {
    int x = threadIdx.x + blockIdx.x * blockDim.x;
    int y = threadIdx.y + blockIdx.y * blockDim.y;
    int offset = x + y * blockDim.x * gridDim.x;

    float fx = x - DIM/2;
    float fy = y - DIM/2;
    float d = sqrtf(fx*fx + fy*fy);

    unsigned char grey = (unsigned char)(128.0f + 127.0f *
                       cos(d/10.0f - ticks/7.0f) /
                       (d/10.0f + 1.0f));

    ptr[offset*4 + 0] = grey;
    ptr[offset*4 + 1] = grey;
    ptr[offset*4 + 2] = grey;
    ptr[offset*4 + 3] = 255;
}
```

ğŸ‘‰ ê° threadê°€ í”½ì…€ ì¢Œí‘œ `(x,y)`ë¥¼ ê³„ì‚°í•´ í•´ë‹¹ ìœ„ì¹˜ ìƒ‰ìƒì„ ê²°ì • â†’ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ìƒì„±.

---

## 5.6 ê³µìœ  ë©”ëª¨ë¦¬ì™€ ë™ê¸°í™” (Shared Memory and Synchronization)

* **ê³µìœ  ë©”ëª¨ë¦¬(shared memory)**: block ë‚´ ëª¨ë“  threadê°€ ê³µìœ í•˜ëŠ” ë¹ ë¥¸ on-chip ë©”ëª¨ë¦¬.
* `__shared__` í‚¤ì›Œë“œë¡œ ì„ ì–¸.
* block ê°„ì—ëŠ” ê³µìœ  ë¶ˆê°€ (block ë‹¨ìœ„ isolation).
* ì´ ë©”ëª¨ë¦¬ë¥¼ ì´ìš©í•˜ë©´ threadë“¤ì´ **ë°ì´í„° êµí™˜, í˜‘ë ¥ ê³„ì‚°** ê°€ëŠ¥.

ë¬¸ì œ: threadë“¤ì´ ë™ì‹œì— ì ‘ê·¼í•˜ë©´ **race condition** ë°œìƒ â†’ ê²°ê³¼ê°€ ë¶ˆí™•ì‹¤.
â†’ í•´ê²°: **ë™ê¸°í™” í•¨ìˆ˜** `__syncthreads()` ì‚¬ìš©.

---

## 5.7 ì˜ˆì œ: ë‚´ì  (Dot Product)

* ë‚´ì (dot product) = ë‘ ë²¡í„°ì˜ ì›ì†Œë³„ ê³± â†’ í•©ì‚° â†’ ìŠ¤ì¹¼ë¼ ê²°ê³¼.
* ë‹¨ê³„:

  1. ê° threadê°€ ë¶€ë¶„ ê³±ì„ ê³„ì‚° í›„ ê³µìœ  ë©”ëª¨ë¦¬ì— ì €ì¥.
  2. `__syncthreads()`ë¡œ ëª¨ë“  threadê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ ë™ê¸°í™”.
  3. ì¼ë¶€ threadê°€ ê³µìœ  ë©”ëª¨ë¦¬ ê°’ë“¤ì„ í•©ì‚° (reduction) ìˆ˜í–‰.

ğŸ‘‰ ì´ë•Œ **ê³µìœ  ë©”ëª¨ë¦¬ + ë™ê¸°í™”**ê°€ thread í˜‘ë ¥ì˜ í•µì‹¬.

---

# ğŸ’¡ ë³´ì¶© ì„¤ëª… (ì œê°€ ì¶”ê°€í•œ í•´ì„¤)

1. **ìŠ¤ë ˆë“œ í˜‘ë ¥ì˜ ì˜ì˜**

   * ë‹¨ìˆœ ë²¡í„° í•©ì€ threadë³„ ë…ë¦½ ê³„ì‚° ê°€ëŠ¥.
   * í•˜ì§€ë§Œ **ë‚´ì , í–‰ë ¬ ê³±, í•©ì‚°(reduction), convolution** ë“±ì€ thread ê°„ í˜‘ë ¥ì´ í•„ìˆ˜.

2. **GPU ì•„í‚¤í…ì²˜ ê³ ë ¤**

   * ê³µìœ  ë©”ëª¨ë¦¬ëŠ” ë§¤ìš° ë¹ ë¥´ì§€ë§Œ í¬ê¸° ì œí•œ(ë³´í†µ 48KB/block).
   * ë™ê¸°í™”ë¥¼ ë‚¨ìš©í•˜ë©´ ì„±ëŠ¥ ì €í•˜ â†’ ìµœì†Œí™” í•„ìš”.

3. **ì‹¤ìŠµ ì•„ì´ë””ì–´**

   * ë²¡í„° í•© ì½”ë“œë¥¼ ë‚´ì ìœ¼ë¡œ í™•ì¥ â†’ ê³µìœ  ë©”ëª¨ë¦¬ ì‚¬ìš©í•´ë³´ê¸°.
   * ë¦¬í”Œ ì• ë‹ˆë©”ì´ì…˜ì˜ ìˆ˜ì‹ì„ ë°”ê¿”ì„œ (ì˜ˆ: `sin`, `tan`) ë‹¤ë¥¸ íŒ¨í„´ ìƒì„±í•´ë³´ê¸°.

---

âœ… ì •ë¦¬í•˜ë©´,
5ì¥ì€ **ìŠ¤ë ˆë“œ í˜‘ë ¥ì˜ ì‹œì‘**ì„ ë‹¤ë£¨ë©°,

* ë²¡í„° í•© â†’ ê¸´ ë²¡í„° â†’ ì„ì˜ ê¸¸ì´ ë²¡í„°
* ì• ë‹ˆë©”ì´ì…˜ ì˜ˆì œ (ë¦¬í”Œ)
* ê³µìœ  ë©”ëª¨ë¦¬ì™€ ë™ê¸°í™”, ë‚´ì (dot product)

ê¹Œì§€ **ë³‘ë ¬ threadë“¤ì˜ í˜‘ë ¥ê³¼ ë™ê¸°í™” ê¸°ì´ˆ**ë¥¼ ë‹¨ê³„ë³„ë¡œ ì†Œê°œí•©ë‹ˆë‹¤.


<!-- ì‹¤ìŠµ ì½”ë“œ ì•ˆë‚´: src/ch5 ì— ì‹¤ìŠµ ì˜ˆì œê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, `make` ë° `make run_*` íƒ€ê¹ƒìœ¼ë¡œ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. -->

